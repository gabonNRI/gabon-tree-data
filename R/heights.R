library('devtools')
#install_github("BIOMASSR/BIOMASS")
#install('BIOMASS')
library(BIOMASS)
#
#install.packages(BIOMASS)
#install.packages("BIOMASS", repos = "https://cran.opencpu.org", method = "libcurl")

# Sample function that simulates a JSON payload that takes three arguments:
# This payload represents NRI_P005 
testPayloadSimple <- function() {
  D <- 10:19
  WD <- runif(length(D), min = 0.1, max = 1)
  H <- D^(2/3)
  # If you have height data
  AGB <- BIOMASS::computeAGB(D,WD,H)
}
testPayload <- function() {
  tagAndDiameterWithHeightsJSON = '

[ {  "Tag": "3407", "D": 40.8, "H": 15.4, "WD": 0.21059999999999998 },
 {  "Tag": "3408", "D": 14.6, "H": 6.8, "WD": 0.40890000000000004 },
  {  "Tag": "3409", "D": 14.5, "H": 5.6, "WD": 0.915 },
  {  "Tag": "3410", "D": 39.7, "H": 7.7, "WD": 0.21059999999999998 },
  {  "Tag": "3411", "D": 14.7, "H": 3.7, "WD": 0.21059999999999998 },
{  "Tag": "3412", "D": 15.7, "H": 4.5, "WD": 0.35786558862981777 },
  {  "Tag": "3413", "D": 11.8, "H": 6, "WD": 0.35786558862981777 },
  {  "Tag": "3414", "D": 11.4, "H": 3.3, "WD": 0.35786558862981777 },
  {  "Tag": "3415", "D": 74.7, "H": 19.7, "WD": 0.21059999999999998 },
  {  "Tag": "3416", "D": 27.2, "H": 19.2, "WD": 0.35786558862981777 },
  {  "Tag": "3417", "D": 13.2, "H": 5.2, "WD": 0.35786558862981777 },
  {  "Tag": "3418", "D": 34.2, "H": 12.6, "WD": 0.21059999999999998 },
  {  "Tag": "3419", "D": 14.4, "H": 3.8, "WD": 0.35786558862981777 },
  {  "Tag": "3420", "D": 33.5, "H": 15.7, "WD": 0.21059999999999998 },
  {  "Tag": "3421", "D": 12.4, "H": 4.3, "WD": 0.5124000000000001 },
  {  "Tag": "3422", "D": 72, "H": 23.5, "WD": 0.21059999999999998 },
  {  "Tag": "3423", "D": 11, "H": 5.7, "WD": 0.553 },
  {  "Tag": "3427", "D": 24.9, "H": 14.3, "WD": 0.35786558862981777 },
  {  "Tag": "3432", "D": 20.3, "H": 19.2, "WD": 0.553 },
  {  "Tag": "3438", "D": 45.7, "H": 11.6, "WD": 0.21059999999999998 },
  {  "Tag": "3441", "D": 40.4, "H": 12.9, "WD": 0.35786558862981777 },
  {  "Tag": "3451", "D": 24.9, "H": 9.6, "WD": 0.35786558862981777 },
  {  "Tag": "3458", "D": 25.7, "H": 18.5, "WD": 0.6577857142857144 },
  {  "Tag": "3461", "D": 37.5, "H": 10.4, "WD": 0.5567999999999999 },
  {  "Tag": "3467", "D": 76.7, "H": 37.4, "WD": 0.35786558862981777 },
  {  "Tag": "3468", "D": 44.7, "H": 12.1, "WD": 0.35786558862981777 },
  {  "Tag": "3474", "D": 31.4, "H": 15.2, "WD": 0.21059999999999998 },
  {  "Tag": "3483", "D": 42.8, "H": 20.1, "WD": 0.24283333333333332 },
  {  "Tag": "3484", "D": 22.6, "H": 14.1, "WD": 0.35786558862981777 },
  {  "Tag": "3487", "D": 76.2, "H": 41.1, "WD": 0.35786558862981777 },
  {  "Tag": "3489", "D": 44.7, "H": 21.5, "WD": 0.749 },
  {  "Tag": "3501", "D": 24.3, "H": 15.5, "WD": 0.21059999999999998 },
  {  "Tag": "3502", "D": 65.3, "H": 25.5, "WD": 0.35786558862981777 },
  {  "Tag": "3504", "D": 20.7, "H": 10.1, "WD": 0.21059999999999998 },
  {  "Tag": "3510", "D": 25.8, "H": 18.5, "WD": 0.21059999999999998 },
  {  "Tag": "3522", "D": 30.9, "H": 18.4, "WD": 0.21059999999999998 },
  {  "Tag": "3523", "D": 30.6, "H": 16, "WD": 0.21059999999999998 },
  {  "Tag": "3529", "D": 30.5, "H": 16, "WD": 0.21059999999999998 },
  {  "Tag": "3530", "D": 29.5, "H": 16.8, "WD": 0.21059999999999998 }
]'
  latitude = -2.8433055556
  longitude = 11.57453
  eValue = 0.0358
  library(jsonlite)
  tagAndDiameterWithHeightsFrame = fromJSON(tagAndDiameterWithHeightsJSON)
  
  computeHeightsWithBiomass(tagAndDiameterWithHeightsFrame, latitude, longitude, eValue)
}
testNRIP005 <- function() {
  tagAndDiameterWithHeightsJSON = '[ { "Tag": "7970", "D": 11.6, "H": 10.2, "WD": 0.761 },
  { "Tag": "7971", "D": 12.5, "H": 17, "WD": 0.761 },
  { "Tag": "7972", "D": 50, "H": 30.46552755570524, "WD": 0.2106 },
  { "Tag": "7973", "D": 11.3, "H": 8.4, "WD": 0.4528 },
  { "Tag": "7974", "D": 128, "H": 35.4, "WD": 0.2806 },
  { "Tag": "7975", "D": 12.6, "H": 9.4, "WD": 0.761 },
  { "Tag": "7976", "D": 19.4, "H": 11.6, "WD": 0.4528 },
  { "Tag": "7977", "D": 12.2, "H": 16.00434802029429, "WD": 0.4528 },
  { "Tag": "7978", "D": 10.3, "H": 10.8, "WD": 0.5163 },
  { "Tag": "7979", "D": 71.2, "H": 36.8, "WD": 0.5142 },
  { "Tag": "7980", "D": 23.8, "H": 16.4, "WD": 0.4053 },
  { "Tag": "7982", "D": 13.6, "H": 13.1, "WD": 0.4053 },
  { "Tag": "7983", "D": 23.9, "H": 21, "WD": 0.3802 },
  { "Tag": "7984", "D": 13.9, "H": 17, "WD": 0.3802 },
  { "Tag": "7985", "D": 13.5, "H": 15.7, "WD": 0.3802 },
  { "Tag": "7986", "D": 11.8, "H": 15.788115865420057, "WD": 0.3802 },
  { "Tag": "7987", "D": 49.3, "H": 21.9, "WD": 0.4528 },
  { "Tag": "7988", "D": 33.4, "H": 13.6, "WD": 0.3802 },
  { "Tag": "7989", "D": 24.4, "H": 17.4, "WD": 0.4528 },
  { "Tag": "7990", "D": 32.1, "H": 17.6, "WD": 0.4053 },
  { "Tag": "7991", "D": 11.4, "H": 15.570212209105033, "WD": 0.4528 },
  { "Tag": "7992", "D": 12.1, "H": 15.95044598195695, "WD": 0.761 },
  { "Tag": "7993", "D": 27.7, "H": 24.9, "WD": 0.2106 },
  { "Tag": "7994", "D": 46.2, "H": 38.7, "WD": 0.4053 },
  { "Tag": "7995", "D": 14.4, "H": 17.164314839910183, "WD": 0.2806 },
  { "Tag": "7996", "D": 21.5, "H": 17.5, "WD": 0.4528 },
  { "Tag": "7997", "D": 22, "H": 10, "WD": 0.4528 },
  { "Tag": "7998", "D": 134, "H": 37.9, "WD": 0.2806 },
  { "Tag": "7999", "D": 15.9, "H": 17.927499548872632, "WD": 0.43 },
  { "Tag": "8000", "D": 49.5, "H": 23.3, "WD": 0.3245 },
  { "Tag": "8383", "D": 37.9, "H": 24.5, "WD": 0.4653 },
  { "Tag": "8384", "D": 33.6, "H": 17.6, "WD": 0.4653 },
  { "Tag": "8385", "D": 24.1, "H": 8.2, "WD": 0.43 },
  { "Tag": "8386", "D": 37.3, "H": 6.3, "WD": 0.43 },
  { "Tag": "8387", "D": 25.9, "H": 11.1, "WD": 0.43 },
  { "Tag": "8388", "D": 14.8, "H": 17.36999040933027, "WD": 0.5142 },
  { "Tag": "8389", "D": 32.1, "H": 20.7, "WD": 0.5142 },
  { "Tag": "8390", "D": 66.4, "H": 20.5, "WD": 0.4053 },
  { "Tag": "8391", "D": 24, "H": 13.9, "WD": 0.5142 },
  { "Tag": "8392", "D": 18.8, "H": 19.341939066770465, "WD": 0.43 },
  { "Tag": "8393", "D": 15.7, "H": 17.827010396203807, "WD": 0.43 },
  { "Tag": "8394", "D": 12.5, "H": 16.16543293044841, "WD": 0.43 },
  { "Tag": "8395", "D": 12.4, "H": 16.111841295354385, "WD": 0.523 },
  { "Tag": "8396", "D": 82, "H": 19, "WD": 0.4053 },
  { "Tag": "8397", "D": 11.9, "H": 15.842330104859155, "WD": 0.4528 },
  { "Tag": "8398", "D": 11.8, "H": 15.788115865420057, "WD": 0.4528 },
  { "Tag": "8399", "D": 12, "H": 15.896440076860731, "WD": 0.5163 },
  { "Tag": "8400", "D": 19.7, "H": 19.765087542914753, "WD": 0.43 },
  { "Tag": "7981", "D": 10.1, "H": 14.8503246775647, "WD": 0.4528 },
  { "Tag": "601", "D": 112, "H": 30.2, "WD": 0.4528 },
  { "Tag": "602", "D": 19.5, "H": 19.67168710927664, "WD": 0.4528 },
  { "Tag": "603", "D": 10.8, "H": 15.240194367641834, "WD": 0.4528 },
  { "Tag": "604", "D": 18, "H": 18.95960268022771, "WD": 0.4528 },
  { "Tag": "605", "D": 11.3, "H": 15.515473610945275, "WD": 0.4528 },
  { "Tag": "606", "D": 14, "H": 16.957049372767347, "WD": 0.4528 },
  { "Tag": "607", "D": 19.4, "H": 19.62485186538002, "WD": 0.4528 },
  { "Tag": "608", "D": 13.6, "H": 16.748181717794704, "WD": 0.4528 },
  { "Tag": "609", "D": 15.6, "H": 17.776620544777153, "WD": 0.4528 },
  { "Tag": "610", "D": 13.2, "H": 16.537699489881128, "WD": 0.4528 },
  { "Tag": "611", "D": 13.2, "H": 16.537699489881128, "WD": 0.4528 },
  { "Tag": "612", "D": 23.1, "H": 6.1, "WD": 0.3802 },
  { "Tag": "613", "D": 14.1, "H": 17.009015462961813, "WD": 0.3802 },
  { "Tag": "614", "D": 17.1, "H": 18.522376854678086, "WD": 0.4496 },
  { "Tag": "615", "D": 15.7, "H": 17.827010396203807, "WD": 0.4053 },
  { "Tag": "616", "D": 14, "H": 16.957049372767347, "WD": 0.3802 },
  { "Tag": "617", "D": 15, "H": 17.472235797254527, "WD": 0.3802 },
  { "Tag": "618", "D": 15.4, "H": 17.675549358011924, "WD": 0.4053 },
  { "Tag": "619", "D": 12.2, "H": 16.00434802029429, "WD": 0.43 },
  { "Tag": "620", "D": 16.2, "H": 18.077509692834727, "WD": 0.43 },
  { "Tag": "621", "D": 48.3, "H": 32.3, "WD": 0.4053 },
  { "Tag": "622", "D": 58.2, "H": 32.2, "WD": 0.4528 },
  { "Tag": "623", "D": 10.4, "H": 15.018055210027281, "WD": 0.4528 },
  { "Tag": "624", "D": 13.8, "H": 16.85281659059396, "WD": 0.5163 },
  { "Tag": "625", "D": 11.7, "H": 15.733797157624856, "WD": 0.761 },
  { "Tag": "626", "D": 12.8, "H": 16.32559020817705, "WD": 0.761 },
  { "Tag": "627", "D": 110, "H": 34.1, "WD": 0.5142 },
  { "Tag": "628", "D": 10, "H": 14.794198889106362, "WD": 0.4528 },
  { "Tag": "1", "D": 24.1, "H": 21.731486989393776, "WD": 0.4816 },
  { "Tag": "2", "D": 18.3, "H": 19.10366929831784, "WD": 0.4816 },
  { "Tag": "3", "D": 11.2, "H": 15.460629534014178, "WD": 0.4816 },
  { "Tag": "4", "D": 11.8, "H": 15.788115865420057, "WD": 0.4816 },
  { "Tag": "5", "D": 15.4, "H": 17.675549358011924, "WD": 0.4816 },
  { "Tag": "6", "D": 13.8, "H": 16.85281659059396, "WD": 0.4816 },
  { "Tag": "7", "D": 16, "H": 17.97759922252873, "WD": 0.4816 },
  { "Tag": "8", "D": 20.1, "H": 19.95081303258982, "WD": 0.4816 },
  { "Tag": "9", "D": 15.3, "H": 17.624867648102402, "WD": 0.4816 },
  { "Tag": "10", "D": 22.9, "H": 21.211606906297202, "WD": 0.5142 },
  { "Tag": "1", "D": 11.6, "H": 15.679373780167825, "WD": 0.5123 },
  { "Tag": "2", "D": 12.9, "H": 16.378770751062767, "WD": 0.4756 },
  { "Tag": "3", "D": 18.8, "H": 19.341939066770465, "WD": 0.4756 },
  { "Tag": "4", "D": 10.2, "H": 14.90634252220234, "WD": 0.5648 },
  { "Tag": "5", "D": 20.3, "H": 20.04314084183227, "WD": 0.4756 },
  { "Tag": "6", "D": 21.4, "H": 20.544638228821405, "WD": 0.4053 },
  { "Tag": "7", "D": 17.1, "H": 18.522376854678086, "WD": 0.424 },
  { "Tag": "8", "D": 13.8, "H": 16.85281659059396, "WD": 0.4053 },
  { "Tag": "9", "D": 11.3, "H": 15.515473610945275, "WD": 0.424 },
  { "Tag": "10", "D": 11.5, "H": 15.62484553135532, "WD": 0.424 },
  { "Tag": "11", "D": 13.4, "H": 16.643143203256116, "WD": 0.4756 },
  { "Tag": "12", "D": 13.3, "H": 16.590472093976103, "WD": 0.4756 },
  { "Tag": "13", "D": 10, "H": 14.794198889106362, "WD": 0.4756 },
  { "Tag": "14", "D": 26.6, "H": 22.77675361239619, "WD": 0.424 },
  { "Tag": "15", "D": 14.7, "H": 17.31871990132287, "WD": 0.6729 },
  { "Tag": "16", "D": 24.3, "H": 21.81697202923623, "WD": 0.6729 },
  { "Tag": "17", "D": 10, "H": 14.794198889106362, "WD": 0.3802 },
  { "Tag": "18", "D": 24.2, "H": 21.774270651114847, "WD": 0.4756 },
  { "Tag": "19", "D": 12.8, "H": 16.32559020817705, "WD": 0.4053 },
  { "Tag": "20", "D": 25.6, "H": 22.364673728108407, "WD": 0.4053 },
  { "Tag": "21", "D": 16.3, "H": 18.127320859753947, "WD": 0.713 },
  { "Tag": "22", "D": 10.3, "H": 14.96225263062204, "WD": 0.523 },
  { "Tag": "23", "D": 10.4, "H": 15.018055210027281, "WD": 0.4756 },
  { "Tag": "24", "D": 27, "H": 22.93937713003729, "WD": 0.6729 },
  { "Tag": "25", "D": 14, "H": 16.957049372767347, "WD": 0.4756 },
  { "Tag": "27", "D": 10.4, "H": 15.018055210027281, "WD": 0.424 },
  { "Tag": "28", "D": 17.2, "H": 18.57133243163639, "WD": 0.6729 },
  { "Tag": "29", "D": 29.4, "H": 23.889253997320736, "WD": 0.4053 },
  { "Tag": "30", "D": 18.6, "H": 19.246906286455406, "WD": 0.4756 },
  { "Tag": "31", "D": 13.1, "H": 16.48482519539533, "WD": 0.4756 },
  { "Tag": "32", "D": 21.7, "H": 20.679577174002837, "WD": 0.4053 },
  { "Tag": "33", "D": 12.6, "H": 16.218921495527592, "WD": 0.4756 },
  { "Tag": "34", "D": 11.4, "H": 15.570212209105033, "WD": 0.3802 },
  { "Tag": "35", "D": 36, "H": 26.28604821829911, "WD": 0.6729 },
  { "Tag": "36", "D": 23, "H": 21.255390426443732, "WD": 0.4756 },
  { "Tag": "37", "D": 14.8, "H": 17.36999040933027, "WD": 0.3802 },
  { "Tag": "38", "D": 15.8, "H": 17.87730333544023, "WD": 0.2806 },
  { "Tag": "39", "D": 17, "H": 18.473326942565407, "WD": 0.6729 },
  { "Tag": "40", "D": 17, "H": 18.473326942565407, "WD": 0.424 },
  { "Tag": "41", "D": 17.7, "H": 18.814701626960705, "WD": 0.4053 },
  { "Tag": "42", "D": 19, "H": 19.43660665535648, "WD": 0.6729 },
  { "Tag": "43", "D": 10.5, "H": 15.073750467223046, "WD": 0.4756 },
  { "Tag": "44", "D": 12.8, "H": 16.32559020817705, "WD": 0.3802 },
  { "Tag": "45", "D": 15.7, "H": 17.827010396203807, "WD": 0.424 },
  { "Tag": "46", "D": 18.4, "H": 19.151506905639835, "WD": 0.4053 },
  { "Tag": "47", "D": 24.2, "H": 21.774270651114847, "WD": 0.4053 },
  { "Tag": "48", "D": 26.6, "H": 22.77675361239619, "WD": 0.424 },
  { "Tag": "49", "D": 13.3, "H": 16.590472093976103, "WD": 0.4756 },
  { "Tag": "50", "D": 15.5, "H": 17.72613359441493, "WD": 0.4053 },
  { "Tag": "51", "D": 14.9, "H": 17.421162311426276, "WD": 0.3802 },
  { "Tag": "52", "D": 11.2, "H": 15.460629534014178, "WD": 0.3802 },
  { "Tag": "53", "D": 12.1, "H": 15.95044598195695, "WD": 0.424 },
  { "Tag": "54", "D": 13.9, "H": 16.904983146297404, "WD": 0.4756 },
  { "Tag": "55", "D": 15.4, "H": 17.675549358011924, "WD": 0.4053 },
  { "Tag": "56", "D": 19.6, "H": 19.718432277375516, "WD": 0.761 },
  { "Tag": "57", "D": 15.2, "H": 17.57408827685938, "WD": 0.4053 },
  { "Tag": "1", "D": 18.7, "H": 19.294468413500155, "WD": 0.4769 },
  { "Tag": "2", "D": 34.7, "H": 25.83772233160994, "WD": 0.4769 },
  { "Tag": "3", "D": 16.1, "H": 18.027602542078473, "WD": 0.761 },
  { "Tag": "4", "D": 20.3, "H": 20.04314084183227, "WD": 0.4769 },
  { "Tag": "5", "D": 27.7, "H": 23.22097235160722, "WD": 0.5142 },
  { "Tag": "6", "D": 61.2, "H": 33.08609805048005, "WD": 0.5142 },
  { "Tag": "7", "D": 23.3, "H": 21.38623639491887, "WD": 0.5202 },
  { "Tag": "8", "D": 21.3, "H": 20.499485121746318, "WD": 0.4053 },
  { "Tag": "10", "D": 26.5, "H": 22.73590168942242, "WD": 0.5142 },
  { "Tag": "11", "D": 54.8, "H": 31.658104986762837, "WD": 0.5142 },
  { "Tag": "12", "D": 16.1, "H": 18.027602542078473, "WD": 0.4769 },
  { "Tag": "13", "D": 15.7, "H": 17.827010396203807, "WD": 0.4769 },
  { "Tag": "14", "D": 130, "H": 41.08063523093099, "WD": 0.2806 },
  { "Tag": "15", "D": 50.3, "H": 30.5433355218247, "WD": 0.4496 },
  { "Tag": "16", "D": 27.1, "H": 22.9798377192395, "WD": 0.5142 },
  { "Tag": "17", "D": 12.2, "H": 16.00434802029429, "WD": 0.2806 },
  { "Tag": "18", "D": 110, "H": 39.720371027187255, "WD": 0.5142 },
  { "Tag": "19", "D": 21.2, "H": 20.45424500670215, "WD": 0.43 },
  { "Tag": "20", "D": 16.3, "H": 18.127320859753947, "WD": 0.4769 },
  { "Tag": "21", "D": 14.5, "H": 17.215882307171466, "WD": 0.2806 },
  { "Tag": "23", "D": 14.3, "H": 17.11264800450155, "WD": 0.4816 },
  { "Tag": "24", "D": 29, "H": 23.733973145959553, "WD": 0.5142 },
  { "Tag": "25", "D": 35.9, "H": 26.251958545286456, "WD": 0.4053 },
  { "Tag": "26", "D": 19.2, "H": 19.53091045557132, "WD": 0.761 },
  { "Tag": "27", "D": 17.7, "H": 18.814701626960705, "WD": 0.4053 } ]'
  
  latitude = -3.37647222222222
  longitude = 11.72433
  eValue = 0.0358
  
  library(jsonlite)
  tagAndDiameterWithHeightsFrame = fromJSON(tagAndDiameterWithHeightsJSON)
  
  computeHeightsWithBiomass(tagAndDiameterWithHeightsFrame, latitude, longitude, eValue)
}
receiveHeightsPayload <- function(tagAndDiameterWithHeightsJSON, eValue) {
  library(jsonlite)
  tagAndDiameterWithHeightsFrame = fromJSON(tagAndDiameterWithHeightsJSON)
  #print(tagAndDiameterWithHeightsFrame)
  #unheightedDiameterFrame = fromJSON(unheightedDiameterJSON)
  latitude = tagAndDiameterWithHeightsFrame$latitude
  longitude = tagAndDiameterWithHeightsFrame$longitude
  #answer = computeHeights(tagAndDiameterWithHeightsFrame, unheightedDiameterFrame, eValue)
  toJSON(answer)
  
}

computeHeightsWithBiomass <- function(measurements, latitude, longitude, eValue) {
  coordinates = cbind(longitude, latitude)
  #answer = tagAndDiameterWithHeightsFrame
  agb = BIOMASS::computeAGB(measurements$D, measurements$WD, measurements$H, coordinates)
  measurements$AGB = agb
  measurements
}
computeHeights <-
  function(tagAndDiameterWithHeightsFrame, unheightedDiameterFrame, eValue = -0.059)
  {
    fit <- heightfit(hdat = tagAndDiameterWithHeightsFrame,
                     sub.dat = unheightedDiameterFrame,
                     E_Value = eValue)
    unheightedDiameterFrame$Ht <- fit$predht
    
    DiameterHeightFrame <- unheightedDiameterFrame
    DH_vars <- fit$vars
    DH_equation <- formula(paste("y ~ ", fit$Xequ, sep = ""))
    #DH_equ2 <- substitute(expr = DH_equation, list(a = DH_vars[1], b = DH_vars[2]))
    DH_equ3 <- gsub("a", round(DH_vars[1], 3), DH_equation)
    DH_equ3 <- gsub("b", round(DH_vars[2], 3), DH_equ3)
    DH_equ3 <- gsub("c", round(DH_vars[3], 3), DH_equ3)
    DH_equ3 <- gsub("d", round(DH_vars[4], 3), DH_equ3)
    DH_equ3 <- formula(paste("y ~ ", DH_equ3[3], sep = ""))
    payload <- list(unheightedDiameterFrame, 
                    Reduce(paste, deparse(DH_equation, width.cutoff = 500)), 
                    Reduce(paste, deparse(DH_equ3, width.cutoff = 500)))
    
    payload
    
    

  }

autorun <- testPayload()
simple <- testPayloadSimple()
nriP005 <- testNRIP005()
